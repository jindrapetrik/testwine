name: build

on:
  push:
    branches: 
        - master        

env:
    CICD_REPO_SLUG: jindrapetrik/jpexs-decompiler
    CICD_REFTYPE: ${{ github.ref_type }}
    CICD_REFNAME: ${{ github.ref_name }}
    CICD_COMMIT: ${{ github.sha }}
    CICD_NAME: GitHub Actions
    CICD_EMAIL: GitHub
    CICD_EVENTNAME: ${{ github.event_name }}

permissions:
  contents: read
  id-token: write

jobs:
  sign:
    runs-on: windows-latest
    env:
      GCP_PROJECT_ID: jpexs-ffdec
      GCP_LOCATION: europe
      KMS_KEYRING: jpexs-ffdec-keyring
      KMS_KEY: jpexs-ffdec-key
      KMS_KEY_VERSION: "1"
      GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON}}
      GOOGLE_APPLICATION_CREDENTIALS: "gcp/credentials.json"
      
      CERT_PATH: "user.crt"
      EXE_PATH: "ffdec.exe"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - id: auth
        uses: google-github-actions/auth@v2
        with:
            workload_identity_provider: "projects/541721778634/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
            service_account: "gha-codesign@jpexs-ffdec.iam.gserviceaccount.com"              
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: "${{ env.GCP_PROJECT_ID }}"
          
      - name: Install Google Cloud KMS CNG Provider
        shell: pwsh
        env:
          GH_TOKEN: ${{secrets.GH_TOKEN}}
        run: |
          $repo = "GoogleCloudPlatform/kms-integrations"
          $tmp  = "$env:RUNNER_TEMP\kms"
          New-Item -ItemType Directory -Force -Path $tmp | Out-Null

          $tag = gh release list `
            --repo $repo `
            --limit 50 `
            --json tagName,createdAt `
            -q '[.[] | select(.tagName | startswith("cng-"))][0].tagName'

          if (-not $tag) {
            throw "No release found with tag cng-*"
          }

          Write-Host "Using release tag: $tag"

          gh release download $tag `
            --repo $repo `
            --pattern "*windows-amd64*.zip" `
            --dir $tmp
          
          $zip = Get-ChildItem $tmp -Filter "*.zip" | Select-Object -First 1
          if (-not $zip) { throw "ZIP asset not found (pattern *windows-amd64*.zip). Check names in releases." }

          $extract = Join-Path $tmp "extract"
          New-Item -ItemType Directory -Force -Path $extract | Out-Null
          Expand-Archive -Path $zip.FullName -DestinationPath $extract -Force

          $msi = Get-ChildItem $extract -Recurse -Filter "*.msi" | Select-Object -First 1
          if (-not $msi) { throw "MSI not found inside ZIP. Check structure of archive in releases." }

          Write-Host "Installing: $($msi.FullName)"

          Start-Process msiexec.exe -Wait -ArgumentList "/i `"$($msi.FullName)`" /qn /norestart"

      #- name: Write Google credentials file
      #  shell: pwsh
      #  run: |
      #    New-Item -ItemType Directory -Force -Path gcp | Out-Null
      #    $abs = Join-Path $PWD "gcp/credentials.json"
      #    $env:GOOGLE_APPLICATION_CREDENTIALS_JSON | Out-File $abs -Encoding utf8 -NoNewline
      #    
      #    "GOOGLE_APPLICATION_CREDENTIALS=$abs" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
      
      - name: Locate signtool
        id: signtool
        shell: pwsh
        run: |
          $candidates = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter signtool.exe -ErrorAction SilentlyContinue |
            Sort-Object FullName -Descending
          if (-not $candidates) { throw "signtool.exe not found. Install Windows SDK or change path." }
          $path = $candidates[0].FullName
          "path=$path" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          
      - name: Sign EXE with KMS key
        shell: pwsh
        run: |
          $signtool = "${{ steps.signtool.outputs.path }}"
          
          certutil -csplist
          certutil -csp "Google Cloud KMS Provider" -csptest

          $kc = "projects/$env:GCP_PROJECT_ID/locations/$env:GCP_LOCATION/keyRings/$env:KMS_KEYRING/cryptoKeys/$env:KMS_KEY/cryptoKeyVersions/$env:KMS_KEY_VERSION"

          & $signtool sign /v /debug `
            /fd sha256 `
            /tr "http://timestamp.sectigo.com?td=sha256" /td sha256 `
            /f "$env:CERT_PATH" `
            /csp "Google Cloud KMS Provider" `
            /kc "$kc" `
            "$env:EXE_PATH"    
      
      - name: Verify signature
        shell: pwsh
        run: |
          $signtool = "${{ steps.signtool.outputs.path }}"
          & $signtool verify /pa /v "$env:EXE_PATH"
     
      - name: Upload signed artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-windows-signed
          path: ffdec.exe
          
      #- name: Cleanup credentials
      #  if: always()
      #  shell: pwsh
      #  run: |
      #    Remove-Item $env:GOOGLE_APPLICATION_CREDENTIALS -Force
#  build:
#
#    runs-on: ubuntu-latest
#    container: debian:sid
#
#    steps:
#    - name: Checkout
#      uses: actions/checkout@v3
    
#    - name: Install Wine
#      run: |
#        dpkg --add-architecture i386
#        apt-get update -y -qq
#        apt-get install -y -qq wine
#        wine --version
#                
#    - name: Install Resource Hacker
#      env:
#        RH_DIR: tools/wine/resourcehacker
#        RH_ZIP: tools/wine/resourcehacker.zip
#        RH_URL: https://www.angusj.com/resourcehacker/resource_hacker.zip
#      run: |              
#        set -euxo pipefail
#        
#        apt-get install -y -qq unzip wget
#        
#        mkdir -p "$(dirname "$RH_ZIP")"
#        mkdir -p "$RH_DIR"
#
#        wget -q -O "$RH_ZIP" "$RH_URL"
#        unzip -o "$RH_ZIP" -d "$RH_DIR"
#        
#    - name: Set up ant
#      run: |
#        apt-get install -y -qq ant 
#        
#    - name: Set up Xorg
#      run: |
#        apt-get install -y -qq xorg xvfb xfonts-100dpi xfonts-75dpi xfonts-scalable xfonts-cyrillic
#        
#    - name: Build
      #env:
        #WINEPREFIX: tools/wine
        #RH_EXE: tools/wine/resourcehacker/ResourceHacker.exe
        #WINEDEBUG: "-all"      
 #     run: |        
        #mkdir -p ${{ github.workspace }}/tools/wine
        #cp ${{ github.workspace }}/hello.exe ${{ github.workspace }}/tools/wine/
        #wine ${{ github.workspace }}/hello.exe
        #cp splash.bmp ${{ github.workspace }}/tools/wine/splash.bmp
        #cp ffdec.exe ${{ github.workspace }}/tools/wine/ffdec.exe
        #wine $RH_EXE -open ${{ github.workspace }}/tools/wine/ffdec.exe -save ${{ github.workspace }}/tools/wine/out.exe -action addoverwrite -res ${{ github.workspace }}/tools/wine/splash.bmp -mask BITMAP,1
        #export WINEPREFIX=$(pwd)/tools/wine
        
        #mkdir -p $WINEPREFIX/resourcehacker
        
        #cp ffdec.exe $WINEPREFIX/resourcehacker/
        #cp splash.bmp $WINEPREFIX/resourcehacker/
        
        #ant build
        
        #xvfb-run wine $WINEPREFIX/resourcehacker/ResourceHacker.exe -open $WINEPREFIX/ffdec.exe -save $WINEPREFIX/out.exe -action addoverwrite -res $WINEPREFIX/splash.bmp -mask BITMAP,1
        #
        #ls -la tools/wine/resourcehacker/
        #cp hello.exe $WINEPREFIX/
        #wine $WINEPREFIX/hello.exe
